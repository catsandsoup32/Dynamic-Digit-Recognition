import torch
import torch.nn as nn
import torch.optim as optim
from torch.utils.data import random_split, Dataset, DataLoader
import torchvision.transforms as transforms
from torchvision import datasets
from torchvision.datasets import ImageFolder
from torchmetrics import Accuracy
from torch.optim.lr_scheduler import StepLR
from tqdm import tqdm

import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
import os
from PIL import Image

# Key changes: change data_dir path

# ------------------------------------------------------------------------------------------------------------------
# Define model
from NEW_models import CNN_9

# transform and init data
from NEW_dataloader import MathSymbolDataset

transform = transforms.Compose([
    transforms.Grayscale(num_output_channels=1),  # Convert to grayscale
    transforms.ToTensor(),
    transforms.Normalize(mean=(0.5,), std=(0.5,)) # subtract 0.5 and then divide 0.5 (z-score)
])


train_dataset = MathSymbolDataset(data_dir='data/extracted_images_new', mode = 'train', transform=transform, seed=42)
train_size = int(0.9 * len(train_dataset)) # split into train and val set
val_size = len(train_dataset) - train_size
new_train_dataset, val_dataset = random_split(dataset=train_dataset, lengths=[train_size, val_size])
test_dataset = MathSymbolDataset(data_dir='data/extracted_images_new', mode = 'test', transform=transform, seed=42)

# ------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------
# Train and val loops
def main(num_epochs, experimentNum, use_model, use_dataset_train, use_dataset_val, use_dataset_test, num_classes, loadFromSaved, test_loop, LR):

    train_loader = DataLoader(use_dataset_train, batch_size=32, shuffle=True, num_workers=5) # num_workers must be with if name
    val_loader = DataLoader(use_dataset_val, batch_size=32, shuffle=False, num_workers=1)
    test_loader = DataLoader(use_dataset_test, batch_size=32, shuffle=False, num_workers=1)

    # About 270,000 elements in new_train_dataset
    # Each element is a length two tuple containing 1: a 1x45x45 tensor and 2: the label number

    # start loop -----------------------------------------------------------------------------------------------------
    num_epochs = num_epochs
    train_losses, val_losses, train_accs, val_accs = [], [], [], []
    
    model = use_model
    criterion = nn.CrossEntropyLoss() # loss function
    optimizer = optim.Adam(model.parameters(), lr = LR)
    scheduler = StepLR(optimizer, step_size = 10, gamma = 0.8)
    accuracy = Accuracy(task='multiclass', num_classes=num_classes)

    device = 'cuda' if torch.cuda.is_available() else 'cpu'
    accuracy = accuracy.to(device)
    model = model.to(device)

    if loadFromSaved is not None:
        model.load_state_dict(torch.load(loadFromSaved, map_location=device, weights_only=True))
    
    for epoch in range(num_epochs):
        model.train()
        running_loss, running_acc = 0.0, 0.0
        accuracy.reset()
        
        for images, labels in tqdm(train_loader, desc=f"Epoch {epoch+1}: training loop"):
            images = images.to(device)
            labels = labels.to(device)

            outputs = model(images) # forward pass
            loss = criterion(outputs, labels) 

            running_loss += loss.item() * images.size(0) # loss tensor times batch size
            running_acc += accuracy(outputs, labels)

            loss.backward()
            optimizer.step()
            optimizer.zero_grad()
            
        train_acc = running_acc / len(train_loader.dataset) * 32 * 100
        train_accs.append(train_acc)
        train_loss = running_loss / len(train_loader.dataset) 
        train_losses.append(train_loss)

        # valid phase
        model.eval()
        running_loss = 0.0
        running_acc = 0.0
        with torch.no_grad():
            for images, labels in tqdm(val_loader, desc=f"Epoch {epoch+1}: val loop"):
                images = images.to(device)
                labels = labels.to(device)
                outputs = model(images)
                loss = criterion(outputs, labels)
                running_loss += loss.item() * images.size(0)
                running_acc += accuracy(outputs, labels)

            val_loss = running_loss / len(val_loader.dataset) 
            val_losses.append(val_loss)
            val_acc = running_acc / len(val_loader.dataset) * 32 * 100
            val_accs.append(val_acc)

        print(f"Epoch {epoch+1}/{num_epochs} - Train loss: {train_loss} train acc: {train_acc}, val loss: {val_loss}, val acc: {val_acc}")
    

        scheduler.step()

        if (epoch+1) % 5 == 0:
            torch.save(model.state_dict(), f'NEW_save_states/CNNmodel{experimentNum}Epoch{epoch+1}.pt')  # Save the trained model\

    torch.save(model.state_dict(), f'NEW_save_states/CNNmodel{experimentNum}Epoch{epoch+1}.pt')  # Save the trained model\

    plt.plot(np.arange(num_epochs), list(train_losses))
    plt.xlabel('Epochs')
    plt.ylabel('Loss')
    plt.title('Loss over time')
    plt.show()

    if test_loop:
        model.eval()
        running_acc = 0.0
        for images, labels in tqdm(test_loader, desc="testing"):
            images = images.to(device)
            labels = labels.to(device)
            outputs = model(images)
            running_acc += accuracy(outputs, images)
        
        test_loss = running_acc / len(test_loader.dataset) * 32 * 100
        print(f"TEST LOSS: {test_loss}")

if __name__ == '__main__':
    main(num_epochs = 40, 
         experimentNum = 15,
         use_model = CNN_9(),
         use_dataset_train = new_train_dataset,
         use_dataset_val = val_dataset,
         use_dataset_test = test_dataset,
         num_classes = 72,
         loadFromSaved = None,
         test_loop = False,
         LR = 0.0035)
    


# Duplicate of everything with NEW_ prefix, start with CNN_9 and adjust

# Experiment 15: 0.0035 LR from 0.003, same as CNN_9 but just increase LR
'''Epoch 1: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.39it/s]
Epoch 1: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 29.86it/s]
Epoch 1/40 - Train loss: 0.45937558140969914 train acc: 88.68730926513672, val loss: 0.24732274643860272, val acc: 93.70996856689453
Epoch 2: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.67it/s]
Epoch 2: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.54it/s]
Epoch 2/40 - Train loss: 0.18454234237646666 train acc: 94.97364807128906, val loss: 1.9220160579135475, val acc: 57.61551284790039
Epoch 3: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:51<00:00, 73.94it/s]
Epoch 3: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.23it/s]
Epoch 3/40 - Train loss: 0.18615601775710186 train acc: 95.10842895507812, val loss: 0.15049016277868232, val acc: 95.97588348388672
Epoch 4: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.39it/s]
Epoch 4: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:28<00:00, 31.78it/s]
Epoch 4/40 - Train loss: 0.17138650530585364 train acc: 95.4870376586914, val loss: 0.14165033476841768, val acc: 96.39839172363281
Epoch 5: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.07it/s]
Epoch 5: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.02it/s]
Epoch 5/40 - Train loss: 0.20220574179787115 train acc: 95.03233337402344, val loss: 0.29490869079321863, val acc: 92.62641906738281
Epoch 6: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.73it/s]
Epoch 6: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 30.59it/s]
Epoch 6/40 - Train loss: 0.16102012599622362 train acc: 95.85920715332031, val loss: 0.2994500079747689, val acc: 94.56181335449219
Epoch 7: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.20it/s]
Epoch 7: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 30.46it/s]
Epoch 7/40 - Train loss: 0.15589046677239726 train acc: 96.1439208984375, val loss: 0.16069201063132135, val acc: 96.30298614501953
Epoch 8: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.67it/s]
Epoch 8: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.12it/s]
Epoch 8/40 - Train loss: 0.211474540655148 train acc: 94.65070343017578, val loss: 0.14651388727735, val acc: 96.81068420410156
Epoch 9: training loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.13it/s]
Epoch 9: val loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.55it/s] 
Epoch 9/40 - Train loss: 0.17570359154028625 train acc: 95.95044708251953, val loss: 0.12629224522040025, val acc: 96.89246368408203
Epoch 10: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:56<00:00, 70.58it/s] 
Epoch 10: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.35it/s] 
Epoch 10/40 - Train loss: 0.1568727637083408 train acc: 96.3460922241211, val loss: 0.15939610235318027, val acc: 95.99632263183594
Epoch 11: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [02:28<00:00, 55.65it/s]
Epoch 11: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.08it/s] 
Epoch 11/40 - Train loss: 0.10804731193058918 train acc: 97.3440933227539, val loss: 0.11652650880130605, val acc: 97.30135345458984
Epoch 12: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.69it/s] 
Epoch 12: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 30.69it/s] 
Epoch 12/40 - Train loss: 0.10638773729217292 train acc: 97.46903228759766, val loss: 0.1315493268570198, val acc: 97.08328247070312
Epoch 13: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.25it/s] 
Epoch 13: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:28<00:00, 31.73it/s] 
Epoch 13/40 - Train loss: 0.1085137977826522 train acc: 97.54286193847656, val loss: 0.11685193749266452, val acc: 97.62505340576172
Epoch 14: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.49it/s] 
Epoch 14: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 29.07it/s] 
Epoch 14/40 - Train loss: 0.10009951043432547 train acc: 97.67915344238281, val loss: 0.11308756527950463, val acc: 97.90105438232422
Epoch 15: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.52it/s] 
Epoch 15: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 29.64it/s] 
Epoch 15/40 - Train loss: 0.11211406425008749 train acc: 97.5530776977539, val loss: 0.12969140154071884, val acc: 97.57735443115234
Epoch 16: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 71.85it/s]
Epoch 16: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.39it/s] 
Epoch 16/40 - Train loss: 0.11379075439849369 train acc: 97.68067169189453, val loss: 0.21844079200647665, val acc: 95.8804702758789
Epoch 17: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.22it/s] 
Epoch 17: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.20it/s] 
Epoch 17/40 - Train loss: 0.10683296141146852 train acc: 97.86051177978516, val loss: 0.12696717113042538, val acc: 97.74771881103516
Epoch 18: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:50<00:00, 74.61it/s] 
Epoch 18: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 30.56it/s] 
Epoch 18/40 - Train loss: 0.12288659445328579 train acc: 97.5417251586914, val loss: 0.10757412412460891, val acc: 97.82609558105469
Epoch 19: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 71.82it/s] 
Epoch 19: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 30.46it/s] 
Epoch 19/40 - Train loss: 0.10937428485177265 train acc: 97.80712890625, val loss: 0.1766848233792817, val acc: 96.40180206298828
Epoch 20: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.03it/s] 
Epoch 20: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.56it/s] 
Epoch 20/40 - Train loss: 0.11986608764227501 train acc: 97.84877014160156, val loss: 0.12011889520158774, val acc: 97.94535064697266
Epoch 21: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [02:17<00:00, 59.87it/s]
Epoch 21: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 29.52it/s] 
Epoch 21/40 - Train loss: 0.07276793161935569 train acc: 98.45113372802734, val loss: 0.08934340782887744, val acc: 98.43260955810547
Epoch 22: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.53it/s] 
Epoch 22: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 28.82it/s] 
Epoch 22/40 - Train loss: 0.07975241248770544 train acc: 98.374267578125, val loss: 0.24639300853394955, val acc: 94.63336944580078
Epoch 23: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.06it/s] 
Epoch 23: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 29.99it/s] 
Epoch 23/40 - Train loss: 0.08141340012204759 train acc: 98.4329605102539, val loss: 0.07974055279529409, val acc: 98.60638427734375
Epoch 24: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [02:01<00:00, 68.06it/s] 
Epoch 24: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 30.85it/s] 
Epoch 24/40 - Train loss: 0.08181070485981508 train acc: 98.60673522949219, val loss: 0.07211679353722233, val acc: 98.79719543457031
Epoch 25: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:56<00:00, 70.80it/s] 
Epoch 25: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:32<00:00, 28.43it/s] 
Epoch 25/40 - Train loss: 0.11754693436781033 train acc: 98.5298843383789, val loss: 0.06533214372515331, val acc: 98.82105255126953
Epoch 26: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [02:09<00:00, 63.50it/s]
Epoch 26: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.36it/s] 
Epoch 26/40 - Train loss: 0.07668943281087137 train acc: 98.52873992919922, val loss: 0.08870549281700195, val acc: 98.6983871459961
Epoch 27: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:54<00:00, 72.05it/s] 
Epoch 27: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 29.37it/s] 
Epoch 27/40 - Train loss: 0.087624230359654 train acc: 98.48028564453125, val loss: 0.06298591838531391, val acc: 98.9334945678711
Epoch 28: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.77it/s]
Epoch 28: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 29.23it/s]
Epoch 28/40 - Train loss: 0.07313264602393653 train acc: 98.62718200683594, val loss: 0.06504647002174395, val acc: 98.88238525390625
Epoch 29: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:53<00:00, 72.59it/s]
Epoch 29: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 30.59it/s]
Epoch 29/40 - Train loss: 0.08898206577799762 train acc: 98.50262451171875, val loss: 0.2627184891380716, val acc: 97.69660949707031
Epoch 30: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.75it/s]
Epoch 30: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.37it/s]
Epoch 30/40 - Train loss: 0.08614370945745095 train acc: 98.56244659423828, val loss: 0.058297397939694885, val acc: 99.1686019897461
Epoch 31: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [02:14<00:00, 61.28it/s]
Epoch 31: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 30.63it/s]
Epoch 31/40 - Train loss: 0.053405812992730395 train acc: 98.93877410888672, val loss: 0.12579503082635682, val acc: 98.48030853271484
Epoch 32: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.20it/s]
Epoch 32: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:30<00:00, 29.81it/s]
Epoch 32/40 - Train loss: 0.2809296436153173 train acc: 98.87857055664062, val loss: 0.2662912901042388, val acc: 97.21276092529297
Epoch 33: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.65it/s]
Epoch 33: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 30.87it/s]
Epoch 33/40 - Train loss: 0.055015790664108964 train acc: 99.00767517089844, val loss: 0.1073122899221554, val acc: 98.83467864990234
Epoch 34: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.69it/s]
Epoch 34: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.06it/s]
Epoch 34/40 - Train loss: 0.05514355483998322 train acc: 98.96073150634766, val loss: 0.08074871826258316, val acc: 99.11067199707031
Epoch 33: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 30.87it/s]
Epoch 33/40 - Train loss: 0.055015790664108964 train acc: 99.00767517089844, val loss: 0.1073122899221554, val acc: 98.83467864990234
Epoch 34: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.69it/s]
Epoch 34: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.06it/s]
Epoch 34/40 - Train loss: 0.05514355483998322 train acc: 98.96073150634766, val loss: 0.08074871826258316, val acc: 99.11067199707031
Epoch 33/40 - Train loss: 0.055015790664108964 train acc: 99.00767517089844, val loss: 0.1073122899221554, val acc: 98.83467864990234
Epoch 34: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:55<00:00, 71.69it/s]
Epoch 34: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.06it/s]
Epoch 34/40 - Train loss: 0.05514355483998322 train acc: 98.96073150634766, val loss: 0.08074871826258316, val acc: 99.11067199707031
Epoch 34: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.06it/s]
Epoch 34/40 - Train loss: 0.05514355483998322 train acc: 98.96073150634766, val loss: 0.08074871826258316, val acc: 99.11067199707031
Epoch 34/40 - Train loss: 0.05514355483998322 train acc: 98.96073150634766, val loss: 0.08074871826258316, val acc: 99.11067199707031
Epoch 35: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.47it/s]
Epoch 35: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.47it/s]
Epoch 35: val loop: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:31<00:00, 29.41it/s]
Epoch 35/40 - Train loss: 0.0661865897157486 train acc: 98.89485168457031, val loss: 0.0940586575903051, val acc: 98.5859375
Epoch 36: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:56<00:00, 70.59it/s]
Epoch 36: training loop: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:56<00:00, 70.59it/s]
Epoch 36: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.53it/s] 
Epoch 36/40 - Train loss: 0.05397532963321866 train acc: 99.0110855102539, val loss: 0.1170006332751191, val acc: 98.78697204589844
Epoch 36: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.53it/s] 
Epoch 36/40 - Train loss: 0.05397532963321866 train acc: 99.0110855102539, val loss: 0.1170006332751191, val acc: 98.78697204589844
Epoch 36/40 - Train loss: 0.05397532963321866 train acc: 99.0110855102539, val loss: 0.1170006332751191, val acc: 98.78697204589844
Epoch 37: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.54it/s] 
Epoch 37: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.35it/s] 
Epoch 37/40 - Train loss: 0.06693552887875703 train acc: 98.89788818359375, val loss: 0.0717643598356483, val acc: 99.15837860107422
Epoch 38: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.50it/s] 
Epoch 38: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.41it/s] 
Epoch 37/40 - Train loss: 0.06693552887875703 train acc: 98.89788818359375, val loss: 0.0717643598356483, val acc: 99.15837860107422
Epoch 38: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.50it/s] 
Epoch 38: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.41it/s] 
Epoch 38/40 - Train loss: 0.06692545596485436 train acc: 98.94331359863281, val loss: 0.11220783568624405, val acc: 98.83126831054688
Epoch 39: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:53<00:00, 72.63it/s] 
Epoch 39: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:28<00:00, 31.66it/s] 
Epoch 39/40 - Train loss: 0.06353907292873771 train acc: 98.9887466430664, val loss: 0.09516933004402674, val acc: 99.03911590576172
Epoch 40: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:51<00:00, 74.11it/s] 
Epoch 40: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.17it/s] 
Epoch 40/40 - Train loss: 0.06470691475075424 train acc: 98.91757202148438, val loss: 0.09432324577125029, val acc: 98.84830474853516
testing:   0%|                                                                                                                                                                                          | 0/2293 [00:08<?, ?it/s] 
Epoch 38: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:52<00:00, 73.50it/s] 
Epoch 38: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.41it/s] 
Epoch 38/40 - Train loss: 0.06692545596485436 train acc: 98.94331359863281, val loss: 0.11220783568624405, val acc: 98.83126831054688
Epoch 39: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:53<00:00, 72.63it/s] 
Epoch 39: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:28<00:00, 31.66it/s] 
Epoch 39/40 - Train loss: 0.06353907292873771 train acc: 98.9887466430664, val loss: 0.09516933004402674, val acc: 99.03911590576172
Epoch 40: training loop: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 8254/8254 [01:51<00:00, 74.11it/s] 
Epoch 40: val loop: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 918/918 [00:29<00:00, 31.17it/s] 
Epoch 40/40 - Train loss: 0.06470691475075424 train acc: 98.91757202148438, val loss: 0.09432324577125029, val acc: 98.84830474853516'''